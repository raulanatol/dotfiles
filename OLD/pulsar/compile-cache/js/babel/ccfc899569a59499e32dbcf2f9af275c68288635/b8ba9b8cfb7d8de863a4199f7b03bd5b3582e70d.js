"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _fsPlus = _interopRequireDefault(require("fs-plus"));
var _humanizePlus = _interopRequireDefault(require("humanize-plus"));
var _lsArchive = _interopRequireDefault(require("ls-archive"));
var _atom = require("atom");
var _etch = _interopRequireDefault(require("etch"));
var _fileView = _interopRequireDefault(require("./file-view"));
var _directoryView = _interopRequireDefault(require("./directory-view"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
/** @babel */
/** @jsx etch.dom */

class ArchiveEditorView {
  constructor(archivePath) {
    this.disposables = new _atom.CompositeDisposable();
    this.emitter = new _atom.Emitter();
    this.path = archivePath;
    this.file = new _atom.File(this.path);
    this.entries = [];
    _etch.default.initialize(this);
    this.refresh();
    this.disposables.add(this.file.onDidChange(() => this.refresh()));
    this.disposables.add(this.file.onDidRename(() => this.refresh()));
    this.disposables.add(this.file.onDidDelete(() => this.destroy()));
    const focusHandler = () => this.focusSelectedFile();
    this.element.addEventListener('focus', focusHandler);
    this.disposables.add(new _atom.Disposable(() => this.element.removeEventListener('focus', focusHandler)));
  }
  update() {}
  render() {
    return _etch.default.dom("div", {
      className: "archive-editor",
      tabIndex: "-1"
    }, _etch.default.dom("div", {
      className: "archive-container"
    }, _etch.default.dom("div", {
      ref: "loadingMessage",
      className: "padded icon icon-hourglass text-info"
    }, `Loading archive\u2026`), _etch.default.dom("div", {
      ref: "errorMessage",
      className: "padded icon icon-alert text-error"
    }), _etch.default.dom("div", {
      className: "inset-panel"
    }, _etch.default.dom("div", {
      ref: "summary",
      className: "panel-heading"
    }), _etch.default.dom("ol", {
      ref: "tree",
      className: "archive-tree padded list-tree has-collapsable-children"
    }))));
  }
  copy() {
    return new ArchiveEditorView(this.path);
  }
  destroy() {
    while (this.entries.length > 0) {
      this.entries.pop().destroy();
    }
    this.disposables.dispose();
    this.emitter.emit('did-destroy');
    _etch.default.destroy(this);
  }
  onDidDestroy(callback) {
    return this.emitter.on('did-destroy', callback);
  }
  onDidChangeTitle(callback) {
    return this.emitter.on('did-change-title', callback);
  }
  serialize() {
    return {
      deserializer: this.constructor.name,
      path: this.path
    };
  }
  getPath() {
    return this.file.getPath();
  }
  getTitle() {
    return this.path ? this.file.getBaseName() : 'untitled';
  }
  getURI() {
    return this.path;
  }
  refresh() {
    this.refs.summary.style.display = 'none';
    this.refs.tree.style.display = 'none';
    this.refs.loadingMessage.style.display = '';
    this.refs.errorMessage.style.display = 'none';
    if (this.path !== this.getPath()) {
      this.path = this.getPath();
      this.emitter.emit('did-change-title');
    }
    const originalPath = this.path;
    _lsArchive.default.list(this.path, {
      tree: true
    }, (error, entries) => {
      if (originalPath !== this.path) {
        return;
      }
      if (error != null) {
        let message = 'Reading the archive file failed';
        if (error.message) {
          message += `: ${error.message}`;
        }
        this.refs.errorMessage.style.display = '';
        this.refs.errorMessage.textContent = message;
      } else {
        this.createTreeEntries(entries);
        this.updateSummary();
      }

      // We hide the loading message _after_ creating the archive tree
      // to avoid forced reflows.
      this.refs.loadingMessage.style.display = 'none';
    });
  }
  createTreeEntries(entries) {
    while (this.entries.length > 0) {
      this.entries.pop().destroy();
    }
    let index = 0;
    for (const entry of entries) {
      if (entry.isDirectory()) {
        const entryView = new _directoryView.default(this, index, this.path, entry);
        this.entries.push(entryView);
      } else {
        const entryView = new _fileView.default(this, index, this.path, entry);
        this.entries.push(entryView);
      }
      index++;
    }
    this.selectFileAfterIndex(-1);

    // Wait until selecting (focusing) the first file before appending the entries
    // to avoid a double-forced reflow when focusing.
    for (const entry of this.entries) {
      this.refs.tree.appendChild(entry.element);
    }
    this.refs.tree.style.display = '';
  }
  updateSummary() {
    const fileCount = this.entries.filter(entry => entry instanceof _fileView.default).length;
    const fileLabel = fileCount === 1 ? '1 file' : `${_humanizePlus.default.intComma(fileCount)} files`;
    const directoryCount = this.entries.filter(entry => entry instanceof _directoryView.default).length;
    const directoryLabel = directoryCount === 1 ? '1 folder' : `${_humanizePlus.default.intComma(directoryCount)} folders`;
    this.refs.summary.style.display = '';
    this.refs.summary.textContent = `${_humanizePlus.default.fileSize(_fsPlus.default.getSizeSync(this.path))} with ${fileLabel} and ${directoryLabel}`;
  }
  focusSelectedFile() {
    const selectedFile = this.refs.tree.querySelector('.selected');
    if (selectedFile) {
      selectedFile.focus();
    }
  }
  selectFileBeforeIndex(index) {
    for (let i = index - 1; i >= 0; i--) {
      const previousEntry = this.entries[i];
      if (previousEntry instanceof _fileView.default) {
        previousEntry.select();
        break;
      } else {
        if (previousEntry.selectLastFile()) {
          break;
        }
      }
    }
  }
  selectFileAfterIndex(index) {
    for (let i = index + 1; i < this.entries.length; i++) {
      const nextEntry = this.entries[i];
      if (nextEntry instanceof _fileView.default) {
        nextEntry.select();
        break;
      } else {
        if (nextEntry.selectFirstFile()) {
          break;
        }
      }
    }
  }
  focus() {
    this.focusSelectedFile();
  }
}
exports.default = ArchiveEditorView;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBcmNoaXZlRWRpdG9yVmlldyIsImNvbnN0cnVjdG9yIiwiYXJjaGl2ZVBhdGgiLCJkaXNwb3NhYmxlcyIsIkNvbXBvc2l0ZURpc3Bvc2FibGUiLCJlbWl0dGVyIiwiRW1pdHRlciIsInBhdGgiLCJmaWxlIiwiRmlsZSIsImVudHJpZXMiLCJldGNoIiwiaW5pdGlhbGl6ZSIsInJlZnJlc2giLCJhZGQiLCJvbkRpZENoYW5nZSIsIm9uRGlkUmVuYW1lIiwib25EaWREZWxldGUiLCJkZXN0cm95IiwiZm9jdXNIYW5kbGVyIiwiZm9jdXNTZWxlY3RlZEZpbGUiLCJlbGVtZW50IiwiYWRkRXZlbnRMaXN0ZW5lciIsIkRpc3Bvc2FibGUiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwidXBkYXRlIiwicmVuZGVyIiwiY29weSIsImxlbmd0aCIsInBvcCIsImRpc3Bvc2UiLCJlbWl0Iiwib25EaWREZXN0cm95IiwiY2FsbGJhY2siLCJvbiIsIm9uRGlkQ2hhbmdlVGl0bGUiLCJzZXJpYWxpemUiLCJkZXNlcmlhbGl6ZXIiLCJuYW1lIiwiZ2V0UGF0aCIsImdldFRpdGxlIiwiZ2V0QmFzZU5hbWUiLCJnZXRVUkkiLCJyZWZzIiwic3VtbWFyeSIsInN0eWxlIiwiZGlzcGxheSIsInRyZWUiLCJsb2FkaW5nTWVzc2FnZSIsImVycm9yTWVzc2FnZSIsIm9yaWdpbmFsUGF0aCIsImFyY2hpdmUiLCJsaXN0IiwiZXJyb3IiLCJtZXNzYWdlIiwidGV4dENvbnRlbnQiLCJjcmVhdGVUcmVlRW50cmllcyIsInVwZGF0ZVN1bW1hcnkiLCJpbmRleCIsImVudHJ5IiwiaXNEaXJlY3RvcnkiLCJlbnRyeVZpZXciLCJEaXJlY3RvcnlWaWV3IiwicHVzaCIsIkZpbGVWaWV3Iiwic2VsZWN0RmlsZUFmdGVySW5kZXgiLCJhcHBlbmRDaGlsZCIsImZpbGVDb3VudCIsImZpbHRlciIsImZpbGVMYWJlbCIsImh1bWFuaXplIiwiaW50Q29tbWEiLCJkaXJlY3RvcnlDb3VudCIsImRpcmVjdG9yeUxhYmVsIiwiZmlsZVNpemUiLCJmcyIsImdldFNpemVTeW5jIiwic2VsZWN0ZWRGaWxlIiwicXVlcnlTZWxlY3RvciIsImZvY3VzIiwic2VsZWN0RmlsZUJlZm9yZUluZGV4IiwiaSIsInByZXZpb3VzRW50cnkiLCJzZWxlY3QiLCJzZWxlY3RMYXN0RmlsZSIsIm5leHRFbnRyeSIsInNlbGVjdEZpcnN0RmlsZSJdLCJzb3VyY2VzIjpbImFyY2hpdmUtZWRpdG9yLXZpZXcuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqIEBiYWJlbCAqL1xuLyoqIEBqc3ggZXRjaC5kb20gKi9cblxuaW1wb3J0IGZzIGZyb20gJ2ZzLXBsdXMnXG5pbXBvcnQgaHVtYW5pemUgZnJvbSAnaHVtYW5pemUtcGx1cydcbmltcG9ydCBhcmNoaXZlIGZyb20gJ2xzLWFyY2hpdmUnXG5pbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGUsIERpc3Bvc2FibGUsIEVtaXR0ZXIsIEZpbGV9IGZyb20gJ2F0b20nXG5pbXBvcnQgZXRjaCBmcm9tICdldGNoJ1xuXG5pbXBvcnQgRmlsZVZpZXcgZnJvbSAnLi9maWxlLXZpZXcnXG5pbXBvcnQgRGlyZWN0b3J5VmlldyBmcm9tICcuL2RpcmVjdG9yeS12aWV3J1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBcmNoaXZlRWRpdG9yVmlldyB7XG4gIGNvbnN0cnVjdG9yIChhcmNoaXZlUGF0aCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKVxuICAgIHRoaXMucGF0aCA9IGFyY2hpdmVQYXRoXG4gICAgdGhpcy5maWxlID0gbmV3IEZpbGUodGhpcy5wYXRoKVxuICAgIHRoaXMuZW50cmllcyA9IFtdXG4gICAgZXRjaC5pbml0aWFsaXplKHRoaXMpXG5cbiAgICB0aGlzLnJlZnJlc2goKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5maWxlLm9uRGlkQ2hhbmdlKCgpID0+IHRoaXMucmVmcmVzaCgpKSlcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLmZpbGUub25EaWRSZW5hbWUoKCkgPT4gdGhpcy5yZWZyZXNoKCkpKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMuZmlsZS5vbkRpZERlbGV0ZSgoKSA9PiB0aGlzLmRlc3Ryb3koKSkpXG5cbiAgICBjb25zdCBmb2N1c0hhbmRsZXIgPSAoKSA9PiB0aGlzLmZvY3VzU2VsZWN0ZWRGaWxlKClcblxuICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdmb2N1cycsIGZvY3VzSGFuZGxlcilcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChuZXcgRGlzcG9zYWJsZSgoKSA9PiB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignZm9jdXMnLCBmb2N1c0hhbmRsZXIpKSlcbiAgfVxuXG4gIHVwZGF0ZSAoKSB7fVxuXG4gIHJlbmRlciAoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPSdhcmNoaXZlLWVkaXRvcicgdGFiSW5kZXg9Jy0xJz5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9J2FyY2hpdmUtY29udGFpbmVyJz5cbiAgICAgICAgICA8ZGl2IHJlZj0nbG9hZGluZ01lc3NhZ2UnIGNsYXNzTmFtZT0ncGFkZGVkIGljb24gaWNvbi1ob3VyZ2xhc3MgdGV4dC1pbmZvJz57YExvYWRpbmcgYXJjaGl2ZVxcdTIwMjZgfTwvZGl2PlxuICAgICAgICAgIDxkaXYgcmVmPSdlcnJvck1lc3NhZ2UnIGNsYXNzTmFtZT0ncGFkZGVkIGljb24gaWNvbi1hbGVydCB0ZXh0LWVycm9yJyAvPlxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdpbnNldC1wYW5lbCc+XG4gICAgICAgICAgICA8ZGl2IHJlZj0nc3VtbWFyeScgY2xhc3NOYW1lPSdwYW5lbC1oZWFkaW5nJyAvPlxuICAgICAgICAgICAgPG9sIHJlZj0ndHJlZScgY2xhc3NOYW1lPSdhcmNoaXZlLXRyZWUgcGFkZGVkIGxpc3QtdHJlZSBoYXMtY29sbGFwc2FibGUtY2hpbGRyZW4nIC8+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9kaXY+XG4gICAgKVxuICB9XG5cbiAgY29weSAoKSB7XG4gICAgcmV0dXJuIG5ldyBBcmNoaXZlRWRpdG9yVmlldyh0aGlzLnBhdGgpXG4gIH1cblxuICBkZXN0cm95ICgpIHtcbiAgICB3aGlsZSAodGhpcy5lbnRyaWVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuZW50cmllcy5wb3AoKS5kZXN0cm95KClcbiAgICB9XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWRlc3Ryb3knKVxuICAgIGV0Y2guZGVzdHJveSh0aGlzKVxuICB9XG5cbiAgb25EaWREZXN0cm95IChjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1kZXN0cm95JywgY2FsbGJhY2spXG4gIH1cblxuICBvbkRpZENoYW5nZVRpdGxlIChjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1jaGFuZ2UtdGl0bGUnLCBjYWxsYmFjaylcbiAgfVxuXG4gIHNlcmlhbGl6ZSAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGRlc2VyaWFsaXplcjogdGhpcy5jb25zdHJ1Y3Rvci5uYW1lLFxuICAgICAgcGF0aDogdGhpcy5wYXRoXG4gICAgfVxuICB9XG5cbiAgZ2V0UGF0aCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuZmlsZS5nZXRQYXRoKClcbiAgfVxuXG4gIGdldFRpdGxlICgpIHtcbiAgICByZXR1cm4gdGhpcy5wYXRoID8gdGhpcy5maWxlLmdldEJhc2VOYW1lKCkgOiAndW50aXRsZWQnXG4gIH1cblxuICBnZXRVUkkgKCkge1xuICAgIHJldHVybiB0aGlzLnBhdGhcbiAgfVxuXG4gIHJlZnJlc2ggKCkge1xuICAgIHRoaXMucmVmcy5zdW1tYXJ5LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSdcbiAgICB0aGlzLnJlZnMudHJlZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnXG4gICAgdGhpcy5yZWZzLmxvYWRpbmdNZXNzYWdlLnN0eWxlLmRpc3BsYXkgPSAnJ1xuICAgIHRoaXMucmVmcy5lcnJvck1lc3NhZ2Uuc3R5bGUuZGlzcGxheSA9ICdub25lJ1xuXG4gICAgaWYgKHRoaXMucGF0aCAhPT0gdGhpcy5nZXRQYXRoKCkpIHtcbiAgICAgIHRoaXMucGF0aCA9IHRoaXMuZ2V0UGF0aCgpXG4gICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWNoYW5nZS10aXRsZScpXG4gICAgfVxuXG4gICAgY29uc3Qgb3JpZ2luYWxQYXRoID0gdGhpcy5wYXRoXG4gICAgYXJjaGl2ZS5saXN0KHRoaXMucGF0aCwge3RyZWU6IHRydWV9LCAoZXJyb3IsIGVudHJpZXMpID0+IHtcbiAgICAgIGlmIChvcmlnaW5hbFBhdGggIT09IHRoaXMucGF0aCkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgaWYgKGVycm9yICE9IG51bGwpIHtcbiAgICAgICAgbGV0IG1lc3NhZ2UgPSAnUmVhZGluZyB0aGUgYXJjaGl2ZSBmaWxlIGZhaWxlZCdcbiAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIHtcbiAgICAgICAgICBtZXNzYWdlICs9IGA6ICR7ZXJyb3IubWVzc2FnZX1gXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZWZzLmVycm9yTWVzc2FnZS5zdHlsZS5kaXNwbGF5ID0gJydcbiAgICAgICAgdGhpcy5yZWZzLmVycm9yTWVzc2FnZS50ZXh0Q29udGVudCA9IG1lc3NhZ2VcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuY3JlYXRlVHJlZUVudHJpZXMoZW50cmllcylcbiAgICAgICAgdGhpcy51cGRhdGVTdW1tYXJ5KClcbiAgICAgIH1cblxuICAgICAgLy8gV2UgaGlkZSB0aGUgbG9hZGluZyBtZXNzYWdlIF9hZnRlcl8gY3JlYXRpbmcgdGhlIGFyY2hpdmUgdHJlZVxuICAgICAgLy8gdG8gYXZvaWQgZm9yY2VkIHJlZmxvd3MuXG4gICAgICB0aGlzLnJlZnMubG9hZGluZ01lc3NhZ2Uuc3R5bGUuZGlzcGxheSA9ICdub25lJ1xuICAgIH0pXG4gIH1cblxuICBjcmVhdGVUcmVlRW50cmllcyAoZW50cmllcykge1xuICAgIHdoaWxlICh0aGlzLmVudHJpZXMubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5lbnRyaWVzLnBvcCgpLmRlc3Ryb3koKVxuICAgIH1cblxuICAgIGxldCBpbmRleCA9IDBcbiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGVudHJpZXMpIHtcbiAgICAgIGlmIChlbnRyeS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgIGNvbnN0IGVudHJ5VmlldyA9IG5ldyBEaXJlY3RvcnlWaWV3KHRoaXMsIGluZGV4LCB0aGlzLnBhdGgsIGVudHJ5KVxuICAgICAgICB0aGlzLmVudHJpZXMucHVzaChlbnRyeVZpZXcpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBlbnRyeVZpZXcgPSBuZXcgRmlsZVZpZXcodGhpcywgaW5kZXgsIHRoaXMucGF0aCwgZW50cnkpXG4gICAgICAgIHRoaXMuZW50cmllcy5wdXNoKGVudHJ5VmlldylcbiAgICAgIH1cbiAgICAgIGluZGV4KytcbiAgICB9XG5cbiAgICB0aGlzLnNlbGVjdEZpbGVBZnRlckluZGV4KC0xKVxuXG4gICAgLy8gV2FpdCB1bnRpbCBzZWxlY3RpbmcgKGZvY3VzaW5nKSB0aGUgZmlyc3QgZmlsZSBiZWZvcmUgYXBwZW5kaW5nIHRoZSBlbnRyaWVzXG4gICAgLy8gdG8gYXZvaWQgYSBkb3VibGUtZm9yY2VkIHJlZmxvdyB3aGVuIGZvY3VzaW5nLlxuICAgIGZvciAoY29uc3QgZW50cnkgb2YgdGhpcy5lbnRyaWVzKSB7XG4gICAgICB0aGlzLnJlZnMudHJlZS5hcHBlbmRDaGlsZChlbnRyeS5lbGVtZW50KVxuICAgIH1cblxuICAgIHRoaXMucmVmcy50cmVlLnN0eWxlLmRpc3BsYXkgPSAnJ1xuICB9XG5cbiAgdXBkYXRlU3VtbWFyeSAoKSB7XG4gICAgY29uc3QgZmlsZUNvdW50ID0gdGhpcy5lbnRyaWVzLmZpbHRlcigoZW50cnkpID0+IGVudHJ5IGluc3RhbmNlb2YgRmlsZVZpZXcpLmxlbmd0aFxuICAgIGNvbnN0IGZpbGVMYWJlbCA9IGZpbGVDb3VudCA9PT0gMSA/ICcxIGZpbGUnIDogYCR7aHVtYW5pemUuaW50Q29tbWEoZmlsZUNvdW50KX0gZmlsZXNgXG5cbiAgICBjb25zdCBkaXJlY3RvcnlDb3VudCA9IHRoaXMuZW50cmllcy5maWx0ZXIoKGVudHJ5KSA9PiBlbnRyeSBpbnN0YW5jZW9mIERpcmVjdG9yeVZpZXcpLmxlbmd0aFxuICAgIGNvbnN0IGRpcmVjdG9yeUxhYmVsID0gZGlyZWN0b3J5Q291bnQgPT09IDEgPyAnMSBmb2xkZXInIDogYCR7aHVtYW5pemUuaW50Q29tbWEoZGlyZWN0b3J5Q291bnQpfSBmb2xkZXJzYFxuXG4gICAgdGhpcy5yZWZzLnN1bW1hcnkuc3R5bGUuZGlzcGxheSA9ICcnXG4gICAgdGhpcy5yZWZzLnN1bW1hcnkudGV4dENvbnRlbnQgPSBgJHtodW1hbml6ZS5maWxlU2l6ZShmcy5nZXRTaXplU3luYyh0aGlzLnBhdGgpKX0gd2l0aCAke2ZpbGVMYWJlbH0gYW5kICR7ZGlyZWN0b3J5TGFiZWx9YFxuICB9XG5cbiAgZm9jdXNTZWxlY3RlZEZpbGUgKCkge1xuICAgIGNvbnN0IHNlbGVjdGVkRmlsZSA9IHRoaXMucmVmcy50cmVlLnF1ZXJ5U2VsZWN0b3IoJy5zZWxlY3RlZCcpXG4gICAgaWYgKHNlbGVjdGVkRmlsZSkge1xuICAgICAgc2VsZWN0ZWRGaWxlLmZvY3VzKClcbiAgICB9XG4gIH1cblxuICBzZWxlY3RGaWxlQmVmb3JlSW5kZXggKGluZGV4KSB7XG4gICAgZm9yIChsZXQgaSA9IGluZGV4IC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgIGNvbnN0IHByZXZpb3VzRW50cnkgPSB0aGlzLmVudHJpZXNbaV1cbiAgICAgIGlmIChwcmV2aW91c0VudHJ5IGluc3RhbmNlb2YgRmlsZVZpZXcpIHtcbiAgICAgICAgcHJldmlvdXNFbnRyeS5zZWxlY3QoKVxuICAgICAgICBicmVha1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHByZXZpb3VzRW50cnkuc2VsZWN0TGFzdEZpbGUoKSkge1xuICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzZWxlY3RGaWxlQWZ0ZXJJbmRleCAoaW5kZXgpIHtcbiAgICBmb3IgKGxldCBpID0gaW5kZXggKyAxOyBpIDwgdGhpcy5lbnRyaWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBuZXh0RW50cnkgPSB0aGlzLmVudHJpZXNbaV1cbiAgICAgIGlmIChuZXh0RW50cnkgaW5zdGFuY2VvZiBGaWxlVmlldykge1xuICAgICAgICBuZXh0RW50cnkuc2VsZWN0KClcbiAgICAgICAgYnJlYWtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChuZXh0RW50cnkuc2VsZWN0Rmlyc3RGaWxlKCkpIHtcbiAgICAgICAgICBicmVha1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZm9jdXMgKCkge1xuICAgIHRoaXMuZm9jdXNTZWxlY3RlZEZpbGUoKVxuICB9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFFQTtBQUNBO0FBQTRDO0FBVjVDO0FBQ0E7O0FBV2UsTUFBTUEsaUJBQWlCLENBQUM7RUFDckNDLFdBQVcsQ0FBRUMsV0FBVyxFQUFFO0lBQ3hCLElBQUksQ0FBQ0MsV0FBVyxHQUFHLElBQUlDLHlCQUFtQixFQUFFO0lBQzVDLElBQUksQ0FBQ0MsT0FBTyxHQUFHLElBQUlDLGFBQU8sRUFBRTtJQUM1QixJQUFJLENBQUNDLElBQUksR0FBR0wsV0FBVztJQUN2QixJQUFJLENBQUNNLElBQUksR0FBRyxJQUFJQyxVQUFJLENBQUMsSUFBSSxDQUFDRixJQUFJLENBQUM7SUFDL0IsSUFBSSxDQUFDRyxP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