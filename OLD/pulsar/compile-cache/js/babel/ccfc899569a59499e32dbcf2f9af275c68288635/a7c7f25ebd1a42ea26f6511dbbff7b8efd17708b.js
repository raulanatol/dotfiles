"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _path = _interopRequireDefault(require("path"));
var _underscorePlus = _interopRequireDefault(require("underscore-plus"));
var _atom = require("atom");
var _etch = _interopRequireDefault(require("etch"));
var _keybindingsPanel = _interopRequireDefault(require("./keybindings-panel"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
/** @babel */
/** @jsx etch.dom */

// Displays the keybindings for a package namespace
class PackageKeymapView {
  constructor(pack) {
    this.pack = pack;
    this.otherPlatformPattern = new RegExp(`\\.platform-(?!${_underscorePlus.default.escapeRegExp(process.platform)}\\b)`);
    this.namespace = this.pack.name;
    this.disposables = new _atom.CompositeDisposable();
    _etch.default.initialize(this);
    const packagesWithKeymapsDisabled = atom.config.get('core.packagesWithKeymapsDisabled') || [];
    this.refs.keybindingToggle.checked = !packagesWithKeymapsDisabled.includes(this.namespace);
    const changeHandler = event => {
      event.stopPropagation();
      const value = this.refs.keybindingToggle.checked;
      if (value) {
        atom.config.removeAtKeyPath('core.packagesWithKeymapsDisabled', this.namespace);
      } else {
        atom.config.pushAtKeyPath('core.packagesWithKeymapsDisabled', this.namespace);
      }
      this.updateKeyBindingView();
    };
    this.refs.keybindingToggle.addEventListener('change', changeHandler);
    this.disposables.add(new _atom.Disposable(() => {
      this.refs.keybindingToggle.removeEventListener('change', changeHandler);
    }));
    const copyIconClickHandler = event => {
      const target = event.target.closest('.copy-icon');
      if (target) {
        event.preventDefault();
        event.stopPropagation();
        this.writeKeyBindingToClipboard(target.closest('tr').dataset);
      }
    };
    this.element.addEventListener('click', copyIconClickHandler);
    this.disposables.add(new _atom.Disposable(() => {
      this.element.removeEventListener('click', copyIconClickHandler);
    }));
    this.updateKeyBindingView();
    let hasKeymaps = false;
    // eslint-disable-next-line no-unused-vars
    for (let [packageKeymapsPath, keymap] of atom.packages.getLoadedPackage(this.namespace).keymaps) {
      if (keymap.length > 0) {
        hasKeymaps = true;
        break;
      }
    }
    if (this.refs.keybindingItems.children.length === 0 && !hasKeymaps) {
      this.element.style.display = 'none';
    }
  }
  update() {}
  destroy() {
    this.disposables.dispose();
    return _etch.default.destroy(this);
  }
  render() {
    return _etch.default.dom("section", {
      className: "section"
    }, _etch.default.dom("div", {
      className: "section-heading icon icon-keyboard"
    }, "Keybindings"), _etch.default.dom("div", {
      className: "checkbox"
    }, _etch.default.dom("label", {
      for: "toggleKeybindings"
    }, _etch.default.dom("input", {
      id: "toggleKeybindings",
      className: "input-checkbox",
      type: "checkbox",
      ref: "keybindingToggle"
    }), _etch.default.dom("div", {
      className: "setting-title"
    }, "Enable")), _etch.default.dom("div", {
      className: "setting-description"
    }, "Disable this if you want to bind your own keystrokes for this package's commands in your keymap.")), _etch.default.dom("table", {
      className: "package-keymap-table table native-key-bindings text",
      tabIndex: "-1"
    }, _etch.default.dom("thead", null, _etch.default.dom("tr", null, _etch.default.dom("th", null, "Keystroke"), _etch.default.dom("th", null, "Command"), _etch.default.dom("th", null, "Selector"), _etch.default.dom("th", null, "Source"))), _etch.default.dom("tbody", {
      ref: "keybindingItems"
    })));
  }
  updateKeyBindingView() {
    this.refs.keybindingItems.innerHTML = '';
    const packagesWithKeymapsDisabled = atom.config.get('core.packagesWithKeymapsDisabled') || [];
    const keybindingsDisabled = packagesWithKeymapsDisabled.includes(this.namespace);
    if (keybindingsDisabled) {
      this.refs.keybindingItems.classList.add('text-subtle');
    } else {
      this.refs.keybindingItems.classList.remove('text-subtle');
    }
    const keyBindings = [];
    if (atom.keymaps.build) {
      // eslint-disable-next-line no-unused-vars
      for (const [keymapPath, keymap] of atom.packages.getLoadedPackage(this.namespace).keymaps) {
        keyBindings.push(...atom.keymaps.build(this.namespace, keymap, 0, false));
      }
    } else {
      // Backwards compatibility for Atom <= 1.19
      for (const keyBinding of atom.keymaps.getKeyBindings()) {
        const {
          command
        } = keyBinding;
        if (command && command.indexOf && command.indexOf(`${this.namespace}:`) === 0) {
          keyBindings.push(keyBinding);
        }
      }
    }
    for (const keyBinding of keyBindings) {
      const {
        command,
        keystrokes,
        selector,
        source
      } = keyBinding;
      if (!command) {
        continue;
      }
      if (this.otherPlatformPattern.test(selector)) {
        continue;
      }
      const keyBindingRow = document.createElement('tr');
      keyBindingRow.dataset.selector = selector;
      keyBindingRow.dataset.keystrokes = keystrokes;
      keyBindingRow.dataset.command = command;
      const keystrokesTd = document.createElement('td');
      const copyIconSpan = document.createElement('span');
      copyIconSpan.classList.add('icon', 'icon-clippy', 'copy-icon');
      keystrokesTd.appendChild(copyIconSpan);
      const keystrokesSpan = document.createElement('span');
      keystrokesSpan.textContent = keystrokes;
      keystrokesTd.appendChild(keystrokesSpan);
      keyBindingRow.appendChild(keystrokesTd);
      const commandTd = document.createElement('td');
      commandTd.textContent = command;
      keyBindingRow.appendChild(commandTd);
      const selectorTd = document.createElement('td');
      selectorTd.textContent = selector;
      keyBindingRow.appendChild(selectorTd);
      const sourceTd = document.createElement('td');
      sourceTd.textContent = _keybindingsPanel.default.determineSource(source);
      keyBindingRow.appendChild(sourceTd);
      this.refs.keybindingItems.appendChild(keyBindingRow);
    }
  }
  writeKeyBindingToClipboard({
    selector,
    keystrokes,
    command
  }) {
    let content;
    const keymapExtension = _path.default.extname(atom.keymaps.getUserKeymapPath());
    if (keymapExtension === '.cson') {
      content = `\
'${selector}':
  '${keystrokes}': '${command}'\
`;
    } else {
      content = `\
"${selector}": {
  "${keystrokes}": "${command}"
}\
`;
    }
    atom.clipboard.write(content);
  }
}
exports.default = PackageKeymapView;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQYWNrYWdlS2V5bWFwVmlldyIsImNvbnN0cnVjdG9yIiwicGFjayIsIm90aGVyUGxhdGZvcm1QYXR0ZXJuIiwiUmVnRXhwIiwiXyIsImVzY2FwZVJlZ0V4cCIsInByb2Nlc3MiLCJwbGF0Zm9ybSIsIm5hbWVzcGFjZSIsIm5hbWUiLCJkaXNwb3NhYmxlcyIsIkNvbXBvc2l0ZURpc3Bvc2FibGUiLCJldGNoIiwiaW5pdGlhbGl6ZSIsInBhY2thZ2VzV2l0aEtleW1hcHNEaXNhYmxlZCIsImF0b20iLCJjb25maWciLCJnZXQiLCJyZWZzIiwia2V5YmluZGluZ1RvZ2dsZSIsImNoZWNrZWQiLCJpbmNsdWRlcyIsImNoYW5nZUhhbmRsZXIiLCJldmVudCIsInN0b3BQcm9wYWdhdGlvbiIsInZhbHVlIiwicmVtb3ZlQXRLZXlQYXRoIiwicHVzaEF0S2V5UGF0aCIsInVwZGF0ZUtleUJpbmRpbmdWaWV3IiwiYWRkRXZlbnRMaXN0ZW5lciIsImFkZCIsIkRpc3Bvc2FibGUiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiY29weUljb25DbGlja0hhbmRsZXIiLCJ0YXJnZXQiLCJjbG9zZXN0IiwicHJldmVudERlZmF1bHQiLCJ3cml0ZUtleUJpbmRpbmdUb0NsaXBib2FyZCIsImRhdGFzZXQiLCJlbGVtZW50IiwiaGFzS2V5bWFwcyIsInBhY2thZ2VLZXltYXBzUGF0aCIsImtleW1hcCIsInBhY2thZ2VzIiwiZ2V0TG9hZGVkUGFja2FnZSIsImtleW1hcHMiLCJsZW5ndGgiLCJrZXliaW5kaW5nSXRlbXMiLCJjaGlsZHJlbiIsInN0eWxlIiwiZGlzcGxheSIsInVwZGF0ZSIsImRlc3Ryb3kiLCJkaXNwb3NlIiwicmVuZGVyIiwiaW5uZXJIVE1MIiwia2V5YmluZGluZ3NEaXNhYmxlZCIsImNsYXNzTGlzdCIsInJlbW92ZSIsImtleUJpbmRpbmdzIiwiYnVpbGQiLCJrZXltYXBQYXRoIiwicHVzaCIsImtleUJpbmRpbmciLCJnZXRLZXlCaW5kaW5ncyIsImNvbW1hbmQiLCJpbmRleE9mIiwia2V5c3Ryb2tlcyIsInNlbGVjdG9yIiwic291cmNlIiwidGVzdCIsImtleUJpbmRpbmdSb3ciLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJrZXlzdHJva2VzVGQiLCJjb3B5SWNvblNwYW4iLCJhcHBlbmRDaGlsZCIsImtleXN0cm9rZXNTcGFuIiwidGV4dENvbnRlbnQiLCJjb21tYW5kVGQiLCJzZWxlY3RvclRkIiwic291cmNlVGQiLCJLZXliaW5kaW5nc1BhbmVsIiwiZGV0ZXJtaW5lU291cmNlIiwiY29udGVudCIsImtleW1hcEV4dGVuc2lvbiIsInBhdGgiLCJleHRuYW1lIiwiZ2V0VXNlcktleW1hcFBhdGgiLCJjbGlwYm9hcmQiLCJ3cml0ZSJdLCJzb3VyY2VzIjpbInBhY2thZ2Uta2V5bWFwLXZpZXcuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqIEBiYWJlbCAqL1xuLyoqIEBqc3ggZXRjaC5kb20gKi9cblxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBfIGZyb20gJ3VuZGVyc2NvcmUtcGx1cydcbmltcG9ydCB7RGlzcG9zYWJsZSwgQ29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSdcbmltcG9ydCBldGNoIGZyb20gJ2V0Y2gnXG5pbXBvcnQgS2V5YmluZGluZ3NQYW5lbCBmcm9tICcuL2tleWJpbmRpbmdzLXBhbmVsJ1xuXG4vLyBEaXNwbGF5cyB0aGUga2V5YmluZGluZ3MgZm9yIGEgcGFja2FnZSBuYW1lc3BhY2VcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBhY2thZ2VLZXltYXBWaWV3IHtcbiAgY29uc3RydWN0b3IgKHBhY2spIHtcbiAgICB0aGlzLnBhY2sgPSBwYWNrXG4gICAgdGhpcy5vdGhlclBsYXRmb3JtUGF0dGVybiA9IG5ldyBSZWdFeHAoYFxcXFwucGxhdGZvcm0tKD8hJHtfLmVzY2FwZVJlZ0V4cChwcm9jZXNzLnBsYXRmb3JtKX1cXFxcYilgKVxuICAgIHRoaXMubmFtZXNwYWNlID0gdGhpcy5wYWNrLm5hbWVcbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIGV0Y2guaW5pdGlhbGl6ZSh0aGlzKVxuXG4gICAgY29uc3QgcGFja2FnZXNXaXRoS2V5bWFwc0Rpc2FibGVkID0gYXRvbS5jb25maWcuZ2V0KCdjb3JlLnBhY2thZ2VzV2l0aEtleW1hcHNEaXNhYmxlZCcpIHx8IFtdXG4gICAgdGhpcy5yZWZzLmtleWJpbmRpbmdUb2dnbGUuY2hlY2tlZCA9ICFwYWNrYWdlc1dpdGhLZXltYXBzRGlzYWJsZWQuaW5jbHVkZXModGhpcy5uYW1lc3BhY2UpXG5cbiAgICBjb25zdCBjaGFuZ2VIYW5kbGVyID0gKGV2ZW50KSA9PiB7XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKVxuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLnJlZnMua2V5YmluZGluZ1RvZ2dsZS5jaGVja2VkXG4gICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgYXRvbS5jb25maWcucmVtb3ZlQXRLZXlQYXRoKCdjb3JlLnBhY2thZ2VzV2l0aEtleW1hcHNEaXNhYmxlZCcsIHRoaXMubmFtZXNwYWNlKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXRvbS5jb25maWcucHVzaEF0S2V5UGF0aCgnY29yZS5wYWNrYWdlc1dpdGhLZXltYXBzRGlzYWJsZWQnLCB0aGlzLm5hbWVzcGFjZSlcbiAgICAgIH1cblxuICAgICAgdGhpcy51cGRhdGVLZXlCaW5kaW5nVmlldygpXG4gICAgfVxuICAgIHRoaXMucmVmcy5rZXliaW5kaW5nVG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGNoYW5nZUhhbmRsZXIpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQobmV3IERpc3Bvc2FibGUoKCkgPT4geyB0aGlzLnJlZnMua2V5YmluZGluZ1RvZ2dsZS5yZW1vdmVFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBjaGFuZ2VIYW5kbGVyKSB9KSlcblxuICAgIGNvbnN0IGNvcHlJY29uQ2xpY2tIYW5kbGVyID0gKGV2ZW50KSA9PiB7XG4gICAgICBjb25zdCB0YXJnZXQgPSBldmVudC50YXJnZXQuY2xvc2VzdCgnLmNvcHktaWNvbicpXG4gICAgICBpZiAodGFyZ2V0KSB7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKClcbiAgICAgICAgdGhpcy53cml0ZUtleUJpbmRpbmdUb0NsaXBib2FyZCh0YXJnZXQuY2xvc2VzdCgndHInKS5kYXRhc2V0KVxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBjb3B5SWNvbkNsaWNrSGFuZGxlcilcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChuZXcgRGlzcG9zYWJsZSgoKSA9PiB7IHRoaXMuZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIGNvcHlJY29uQ2xpY2tIYW5kbGVyKSB9KSlcblxuICAgIHRoaXMudXBkYXRlS2V5QmluZGluZ1ZpZXcoKVxuXG4gICAgbGV0IGhhc0tleW1hcHMgPSBmYWxzZVxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtdmFyc1xuICAgIGZvciAobGV0IFtwYWNrYWdlS2V5bWFwc1BhdGgsIGtleW1hcF0gb2YgYXRvbS5wYWNrYWdlcy5nZXRMb2FkZWRQYWNrYWdlKHRoaXMubmFtZXNwYWNlKS5rZXltYXBzKSB7XG4gICAgICBpZiAoa2V5bWFwLmxlbmd0aCA+IDApIHtcbiAgICAgICAgaGFzS2V5bWFwcyA9IHRydWVcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZWZzLmtleWJpbmRpbmdJdGVtcy5jaGlsZHJlbi5sZW5ndGggPT09IDAgJiYgIWhhc0tleW1hcHMpIHtcbiAgICAgIHRoaXMuZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnXG4gICAgfVxuICB9XG5cbiAgdXBkYXRlICgpIHt9XG5cbiAgZGVzdHJveSAoKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICByZXR1cm4gZXRjaC5kZXN0cm95KHRoaXMpXG4gIH1cblxuICByZW5kZXIgKCkge1xuICAgIHJldHVybiAoXG4gICAgICA8c2VjdGlvbiBjbGFzc05hbWU9J3NlY3Rpb24nPlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2VjdGlvbi1oZWFkaW5nIGljb24gaWNvbi1rZXlib2FyZCc+S2V5YmluZGluZ3M8L2Rpdj5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9J2NoZWNrYm94Jz5cbiAgICAgICAgICA8bGFiZWwgZm9yPSd0b2dnbGVLZXliaW5kaW5ncyc+XG4gICAgICAgICAgICA8aW5wdXQgaWQ9J3RvZ2dsZUtleWJpbmRpbmdzJyBjbGFzc05hbWU9J2lucHV0LWNoZWNrYm94JyB0eXBlPSdjaGVja2JveCcgcmVmPSdrZXliaW5kaW5nVG9nZ2xlJyAvPlxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NldHRpbmctdGl0bGUnPkVuYWJsZTwvZGl2PlxuICAgICAgICAgIDwvbGFiZWw+XG4gICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NldHRpbmctZGVzY3JpcHRpb24nPlxuICAgICAgICAgICAge1wiRGlzYWJsZSB0aGlzIGlmIHlvdSB3YW50IHRvIGJpbmQgeW91ciBvd24ga2V5c3Ryb2tlcyBmb3IgdGhpcyBwYWNrYWdlJ3MgY29tbWFuZHMgaW4geW91ciBrZXltYXAuXCJ9XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdwYWNrYWdlLWtleW1hcC10YWJsZSB0YWJsZSBuYXRpdmUta2V5LWJpbmRpbmdzIHRleHQnIHRhYkluZGV4PSctMSc+XG4gICAgICAgICAgPHRoZWFkPlxuICAgICAgICAgICAgPHRyPlxuICAgICAgICAgICAgICA8dGg+S2V5c3Ryb2tlPC90aD5cbiAgICAgICAgICAgICAgPHRoPkNvbW1hbmQ8L3RoPlxuICAgICAgICAgICAgICA8dGg+U2VsZWN0b3I8L3RoPlxuICAgICAgICAgICAgICA8dGg+U291cmNlPC90aD5cbiAgICAgICAgICAgIDwvdHI+XG4gICAgICAgICAgPC90aGVhZD5cbiAgICAgICAgICA8dGJvZHkgcmVmPSdrZXliaW5kaW5nSXRlbXMnIC8+XG4gICAgICAgIDwvdGFibGU+XG4gICAgICA8L3NlY3Rpb24+XG4gICAgKVxuICB9XG5cbiAgdXBkYXRlS2V5QmluZGluZ1ZpZXcgKCkge1xuICAgIHRoaXMucmVmcy5rZXliaW5kaW5nSXRlbXMuaW5uZXJIVE1MID0gJydcblxuICAgIGNvbnN0IHBhY2thZ2VzV2l0aEtleW1hcHNEaXNhYmxlZCA9IGF0b20uY29uZmlnLmdldCgnY29yZS5wYWNrYWdlc1dpdGhLZXltYXBzRGlzYWJsZWQnKSB8fCBbXVxuICAgIGNvbnN0IGtleWJpbmRpbmdzRGlzYWJsZWQgPSBwYWNrYWdlc1dpdGhLZXltYXBzRGlzYWJsZWQuaW5jbHVkZXModGhpcy5uYW1lc3BhY2UpXG4gICAgaWYgKGtleWJpbmRpbmdzRGlzYWJsZWQpIHtcbiAgICAgIHRoaXMucmVmcy5rZXliaW5kaW5nSXRlbXMuY2xhc3NMaXN0LmFkZCgndGV4dC1zdWJ0bGUnKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlZnMua2V5YmluZGluZ0l0ZW1zLmNsYXNzTGlzdC5yZW1vdmUoJ3RleHQtc3VidGxlJylcbiAgICB9XG5cbiAgICBjb25zdCBrZXlCaW5kaW5ncyA9IFtdXG4gICAgaWYgKGF0b20ua2V5bWFwcy5idWlsZCkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzXG4gICAgICBmb3IgKGNvbnN0IFtrZXltYXBQYXRoLCBrZXltYXBdIG9mIGF0b20ucGFja2FnZXMuZ2V0TG9hZGVkUGFja2FnZSh0aGlzLm5hbWVzcGFjZSkua2V5bWFwcykge1xuICAgICAgICBrZXlCaW5kaW5ncy5wdXNoKC4uLmF0b20ua2V5bWFwcy5idWlsZCh0aGlzLm5hbWVzcGFjZSwga2V5bWFwLCAwLCBmYWxzZSkpXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGZvciBBdG9tIDw9IDEuMTlcbiAgICAgIGZvciAoY29uc3Qga2V5QmluZGluZyBvZiBhdG9tLmtleW1hcHMuZ2V0S2V5QmluZGluZ3MoKSkge1xuICAgICAgICBjb25zdCB7Y29tbWFuZH0gPSBrZXlCaW5kaW5nXG4gICAgICAgIGlmIChjb21tYW5kICYmIGNvbW1hbmQuaW5kZXhPZiAmJiBjb21tYW5kLmluZGV4T2YoYCR7dGhpcy5uYW1lc3BhY2V9OmApID09PSAwKSB7XG4gICAgICAgICAga2V5QmluZGluZ3MucHVzaChrZXlCaW5kaW5nKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBrZXlCaW5kaW5nIG9mIGtleUJpbmRpbmdzKSB7XG4gICAgICBjb25zdCB7Y29tbWFuZCwga2V5c3Ryb2tlcywgc2VsZWN0b3IsIHNvdXJjZX0gPSBrZXlCaW5kaW5nXG4gICAgICBpZiAoIWNvbW1hbmQpIHtcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMub3RoZXJQbGF0Zm9ybVBhdHRlcm4udGVzdChzZWxlY3RvcikpIHtcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cblxuICAgICAgY29uc3Qga2V5QmluZGluZ1JvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RyJylcbiAgICAgIGtleUJpbmRpbmdSb3cuZGF0YXNldC5zZWxlY3RvciA9IHNlbGVjdG9yXG4gICAgICBrZXlCaW5kaW5nUm93LmRhdGFzZXQua2V5c3Ryb2tlcyA9IGtleXN0cm9rZXNcbiAgICAgIGtleUJpbmRpbmdSb3cuZGF0YXNldC5jb21tYW5kID0gY29tbWFuZFxuXG4gICAgICBjb25zdCBrZXlzdHJva2VzVGQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZCcpXG5cbiAgICAgIGNvbnN0IGNvcHlJY29uU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKVxuICAgICAgY29weUljb25TcGFuLmNsYXNzTGlzdC5hZGQoJ2ljb24nLCAnaWNvbi1jbGlwcHknLCAnY29weS1pY29uJylcbiAgICAgIGtleXN0cm9rZXNUZC5hcHBlbmRDaGlsZChjb3B5SWNvblNwYW4pXG5cbiAgICAgIGNvbnN0IGtleXN0cm9rZXNTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpXG4gICAgICBrZXlzdHJva2VzU3Bhbi50ZXh0Q29udGVudCA9IGtleXN0cm9rZXNcbiAgICAgIGtleXN0cm9rZXNUZC5hcHBlbmRDaGlsZChrZXlzdHJva2VzU3BhbilcblxuICAgICAga2V5QmluZGluZ1Jvdy5hcHBlbmRDaGlsZChrZXlzdHJva2VzVGQpXG5cbiAgICAgIGNvbnN0IGNvbW1hbmRUZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RkJylcbiAgICAgIGNvbW1hbmRUZC50ZXh0Q29udGVudCA9IGNvbW1hbmRcbiAgICAgIGtleUJpbmRpbmdSb3cuYXBwZW5kQ2hpbGQoY29tbWFuZFRkKVxuXG4gICAgICBjb25zdCBzZWxlY3RvclRkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKVxuICAgICAgc2VsZWN0b3JUZC50ZXh0Q29udGVudCA9IHNlbGVjdG9yXG4gICAgICBrZXlCaW5kaW5nUm93LmFwcGVuZENoaWxkKHNlbGVjdG9yVGQpXG5cbiAgICAgIGNvbnN0IHNvdXJjZVRkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKVxuICAgICAgc291cmNlVGQudGV4dENvbnRlbnQgPSBLZXliaW5kaW5nc1BhbmVsLmRldGVybWluZVNvdXJjZShzb3VyY2UpXG4gICAgICBrZXlCaW5kaW5nUm93LmFwcGVuZENoaWxkKHNvdXJjZVRkKVxuXG4gICAgICB0aGlzLnJlZnMua2V5YmluZGluZ0l0ZW1zLmFwcGVuZENoaWxkKGtleUJpbmRpbmdSb3cpXG4gICAgfVxuICB9XG5cbiAgd3JpdGVLZXlCaW5kaW5nVG9DbGlwYm9hcmQgKHtzZWxlY3Rvciwga2V5c3Ryb2tlcywgY29tbWFuZH0pIHtcbiAgICBsZXQgY29udGVudFxuICAgIGNvbnN0IGtleW1hcEV4dGVuc2lvbiA9IHBhdGguZXh0bmFtZShhdG9tLmtleW1hcHMuZ2V0VXNlcktleW1hcFBhdGgoKSlcbiAgICBpZiAoa2V5bWFwRXh0ZW5zaW9uID09PSAnLmNzb24nKSB7XG4gICAgICBjb250ZW50ID0gYFxcXG4nJHtzZWxlY3Rvcn0nOlxuICAnJHtrZXlzdHJva2VzfSc6ICcke2NvbW1hbmR9J1xcXG5gXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnRlbnQgPSBgXFxcblwiJHtzZWxlY3Rvcn1cIjoge1xuICBcIiR7a2V5c3Ryb2tlc31cIjogXCIke2NvbW1hbmR9XCJcbn1cXFxuYFxuICAgIH1cblxuICAgIGF0b20uY2xpcGJvYXJkLndyaXRlKGNvbnRlbnQpXG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBR0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUFrRDtBQVBsRDtBQUNBOztBQVFBO0FBQ2UsTUFBTUEsaUJBQWlCLENBQUM7RUFDckNDLFdBQVcsQ0FBRUMsSUFBSSxFQUFFO0lBQ2pCLElBQUksQ0FBQ0EsSUFBSSxHQUFHQSxJQUFJO0lBQ2hCLElBQUksQ0FBQ0Msb0JBQW9CLEdBQUcsSUFBSUMsTUFBTSxDQUFFLGtCQUFpQkMsdUJBQUMsQ0FBQ0MsWUFBWSxDQUFDQyxPQUFPLENBQUNDLFFBQVEsQ0FBRSxNQUFLLENBQUM7SUFDaEcsSUFBSSxDQUFDQyxTQUFTLEdBQUcsSUFBSSxDQUFDUCxJQUFJLENBQUNRLElBQUk7SUFDL0IsSUFBSSxDQUFDQyxXQUFXLEdBQUcsSUFBSUMseUJBQW1CLEVBQUU7SUFDNUNDLGFBQUksQ0FBQ0MsVUFBVSxDQUFDLElBQUksQ0FBQztJQUVyQixNQUFNQywyQkFBMkIsR0FBR0MsSUFBSSxDQUFDQyxNQUFNLENBQUNDLEdBQUcsQ0FBQyxrQ0FBa0MsQ0FBQyxJQUFJLEVBQUU7SUFDN0YsSUFBSSxDQUFDQyxJQUFJLENBQUNDLGdCQUFnQixDQUFDQyxPQUFPLEdBQUcsQ0FBQ04sMkJBQTJCLENBQUNPLFFBQVEsQ0FBQyxJQUFJLENBQUNiLFNBQVMsQ0FBQztJQUUxRixNQUFNYyxhQUFhLEdBQUlDLEtBQUssSUFBSztNQUMvQkEsS0FBSyxDQUFDQyxlQUFlLEVBQUU7TUFDdkIsTUFBTUMsS0FBSyxHQUFHLElBQUksQ0FBQ1AsSUFBSSxDQUFDQyxnQkFBZ0IsQ0FBQ0MsT0FBTztNQUNoRCxJQUFJSyxLQUFLLEVBQUU7UUFDVFYsSUFBSSxDQUFDQyxNQUFNLENBQUNVLGVBQWUsQ0FBQyxrQ0FBa0MsRUFBRSxJQUFJLENBQUNsQixTQUFTLENBQUM7TUFDakYsQ0FBQyxNQUFNO1FBQ0xPLElBQUksQ0FBQ0MsTUFBTSxDQUFDVyxhQUFhLENBQUMsa0NBQWtDLEVBQUUsSUFBSSxDQUFDbkIsU0FBUyxDQUFDO01BQy9FO01BRUEsSUFBSSxDQUFDb0Isb0JBQW9CLEVBQUU7SUFDN0IsQ0FBQztJQUNELElBQUksQ0FBQ1YsSUFBSSxDQUFDQyxnQkFBZ0IsQ0FBQ1UsZ0JBQWdCLENBQUMsUUFBUSxFQUFFUCxhQUFhLENBQUM7SUFDcEUsSUFBSSxDQUFDWixXQUFXLENBQUNvQixHQUFHLENBQUMsSUFBSUMsZ0JBQVUsQ0FBQyxNQUFNO01BQUUsSUFBSSxDQUFDYixJQUFJLENBQUNDLGdCQUFnQixDQUFDYSxtQkFBbUIsQ0FBQyxRQUFRLEVBQUVWLGFBQWEsQ0FBQztJQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXZILE1BQU1XLG9CQUFvQixHQUFJVixLQUFLLElBQUs7TUFDdEMsTUFBTVcsTUFBTSxHQUFHWCxLQUFLLENBQUNXLE1BQU0sQ0FBQ0MsT0FBTyxDQUFDLFlBQVksQ0FBQztNQUNqRCxJQUFJRCxNQUFNLEVBQUU7UUFDVlgsS0FBSyxDQUFDYSxjQUFjLEVBQUU7UUFDdEJiLEtBQUssQ0FBQ0MsZUFBZSxFQUFFO1FBQ3ZCLElBQUksQ0FBQ2EsMEJBQTBCLENBQUNILE1BQU0sQ0FBQ0MsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDRyxPQUFPLENBQUM7TUFDL0Q7SUFDRixDQUFDO0lBQ0QsSUFBSSxDQUFDQyxPQUFPLENBQUNWLGdCQUFnQixDQUFDLE9BQU8sRUFBRUksb0JBQW9CLENBQUM7SUFDNUQsSUFBSSxDQUFDdkIsV0FBVyxDQUFDb0IsR0FBRyxDQUFDLElBQUlDLGdCQUFVLENBQUMsTUFBTTtNQUFFLElBQUksQ0FBQ1EsT0FBTyxDQUFDUCxtQkFBbUIsQ0FBQyxPQUFPLEVBQUVDLG9CQUFvQixDQUFDO0lBQUMsQ0FBQyxDQUFDLENBQUM7SUFFL0csSUFBSSxDQUFDTCxvQkFBb0IsRUFBRTtJQUUzQixJQUFJWSxVQUFVLEdBQUcsS0FBSztJQUN0QjtJQUNBLEtBQUssSUFBSSxDQUFDQyxrQkFBa0IsRUFBRUMsTUFBTSxDQUFDLElBQUkzQixJQUFJLENBQUM0QixRQUFRLENBQUNDLGdCQUFnQixDQUFDLElBQUksQ0FBQ3BDLFNBQVMsQ0FBQyxDQUFDcUMsT0FBTyxFQUFFO01BQy9GLElBQUlILE1BQU0sQ0FBQ0ksTUFBTSxHQUFHLENBQUMsRUFBRTtRQUNyQk4sVUFBVSxHQUFHLElBQUk7UUFDakI7TUFDRjtJQUNGO0lBRUEsSUFBSSxJQUFJLENBQUN0QixJQUFJLENBQUM2QixlQUFlLENBQUNDLFFBQVEsQ0FBQ0YsTUFBTSxLQUFLLENBQUMsSUFBSSxDQUFDTixVQUFVLEVBQUU7TUFDbEUsSUFBSSxDQUFDRCxPQUFPLENBQUNVLEtBQUssQ0FBQ0MsT0FBTyxHQUFHLE1BQU07SUFDckM7RUFDRjtFQUVBQyxNQUFNLEdBQUksQ0FBQztFQUVYQyxPQUFPLEdBQUk7SUFDVCxJQUFJLENBQUMxQyxXQUFXLENBQUMyQyxPQUFPLEVBQUU7SUFDMUIsT0FBT3pDLGFBQUksQ0FBQ3dDLE9BQU8sQ0FBQyxJQUFJLENBQUM7RUFDM0I7RUFFQUUsTUFBTSxHQUFJO0lBQ1IsT0FDRTtNQUFTLFNBQVMsRUFBQztJQUFTLEdBQzFCO01BQUssU0FBUyxFQUFDO0lBQW9DLGlCQUFrQixFQUNyRTtNQUFLLFNBQVMsRUFBQztJQUFVLEdBQ3ZCO01BQU8sR0FBRyxFQUFDO0lBQW1CLEdBQzVCO01BQU8sRUFBRSxFQUFDLG1CQUFtQjtNQUFDLFNBQVMsRUFBQyxnQkFBZ0I7TUFBQyxJQUFJLEVBQUMsVUFBVTtNQUFDLEdBQUcsRUFBQztJQUFrQixFQUFHLEVBQ2xHO01BQUssU0FBUyxFQUFDO0lBQWUsWUFBYSxDQUNyQyxFQUNSO01BQUssU0FBUyxFQUFDO0lBQXFCLEdBQ2pDLGtHQUFrRyxDQUMvRixDQUNGLEVBQ047TUFBTyxTQUFTLEVBQUMscURBQXFEO01BQUMsUUFBUSxFQUFDO0lBQUksR0FDbEYsaUNBQ0UsOEJBQ0UsMENBQWtCLEVBQ2xCLHdDQUFnQixFQUNoQix5Q0FBaUIsRUFDakIsdUNBQWUsQ0FDWixDQUNDLEVBQ1I7TUFBTyxHQUFHLEVBQUM7SUFBaUIsRUFBRyxDQUN6QixDQUNBO0VBRWQ7RUFFQTFCLG9CQUFvQixHQUFJO0lBQ3RCLElBQUksQ0FBQ1YsSUFBSSxDQUFDNkIsZUFBZSxDQUFDUSxTQUFTLEdBQUcsRUFBRTtJQUV4QyxNQUFNekMsMkJBQTJCLEdBQUdDLElBQUksQ0FBQ0MsTUFBTSxDQUFDQyxHQUFHLENBQUMsa0NBQWtDLENBQUMsSUFBSSxFQUFFO0lBQzdGLE1BQU11QyxtQkFBbUIsR0FBRzFDLDJCQUEyQixDQUFDTyxRQUFRLENBQUMsSUFBSSxDQUFDYixTQUFTLENBQUM7SUFDaEYsSUFBSWdELG1CQUFtQixFQUFFO01BQ3ZCLElBQUksQ0FBQ3RDLElBQUksQ0FBQzZCLGVBQWUsQ0FBQ1UsU0FBUyxDQUFDM0IsR0FBRyxDQUFDLGFBQWEsQ0FBQztJQUN4RCxDQUFDLE1BQU07TUFDTCxJQUFJLENBQUNaLElBQUksQ0FBQzZCLGVBQWUsQ0FBQ1UsU0FBUyxDQUFDQyxNQUFNLENBQUMsYUFBYSxDQUFDO0lBQzNEO0lBRUEsTUFBTUMsV0FBVyxHQUFHLEVBQUU7SUFDdEIsSUFBSTVDLElBQUksQ0FBQzhCLE9BQU8sQ0FBQ2UsS0FBSyxFQUFFO01BQ3RCO01BQ0EsS0FBSyxNQUFNLENBQUNDLFVBQVUsRUFBRW5CLE1BQU0sQ0FBQyxJQUFJM0IsSUFBSSxDQUFDNEIsUUFBUSxDQUFDQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUNwQyxTQUFTLENBQUMsQ0FBQ3FDLE9BQU8sRUFBRTtRQUN6RmMsV0FBVyxDQUFDRyxJQUFJLENBQUMsR0FBRy9DLElBQUksQ0FBQzhCLE9BQU8sQ0FBQ2UsS0FBSyxDQUFDLElBQUksQ0FBQ3BELFNBQVMsRUFBRWtDLE1BQU0sRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7TUFDM0U7SUFDRixDQUFDLE1BQU07TUFDTDtNQUNBLEtBQUssTUFBTXFCLFVBQVUsSUFBSWhELElBQUksQ0FBQzhCLE9BQU8sQ0FBQ21CLGNBQWMsRUFBRSxFQUFFO1FBQ3RELE1BQU07VUFBQ0M7UUFBTyxDQUFDLEdBQUdGLFVBQVU7UUFDNUIsSUFBSUUsT0FBTyxJQUFJQSxPQUFPLENBQUNDLE9BQU8sSUFBSUQsT0FBTyxDQUFDQyxPQUFPLENBQUUsR0FBRSxJQUFJLENBQUMxRCxTQUFVLEdBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRTtVQUM3RW1ELFdBQVcsQ0FBQ0csSUFBSSxDQUFDQyxVQUFVLENBQUM7UUFDOUI7TUFDRjtJQUNGO0lBRUEsS0FBSyxNQUFNQSxVQUFVLElBQUlKLFdBQVcsRUFBRTtNQUNwQyxNQUFNO1FBQUNNLE9BQU87UUFBRUUsVUFBVTtRQUFFQyxRQUFRO1FBQUVDO01BQU0sQ0FBQyxHQUFHTixVQUFVO01BQzFELElBQUksQ0FBQ0UsT0FBTyxFQUFFO1FBQ1o7TUFDRjtNQUVBLElBQUksSUFBSSxDQUFDL0Qsb0JBQW9CLENBQUNvRSxJQUFJLENBQUNGLFFBQVEsQ0FBQyxFQUFFO1FBQzVDO01BQ0Y7TUFFQSxNQUFNRyxhQUFhLEdBQUdDLFFBQVEsQ0FBQ0MsYUFBYSxDQUFDLElBQUksQ0FBQztNQUNsREYsYUFBYSxDQUFDakMsT0FBTyxDQUFDOEIsUUFBUSxHQUFHQSxRQUFRO01BQ3pDRyxhQUFhLENBQUNqQyxPQUFPLENBQUM2QixVQUFVLEdBQUdBLFVBQVU7TUFDN0NJLGFBQWEsQ0FBQ2pDLE9BQU8sQ0FBQzJCLE9BQU8sR0FBR0EsT0FBTztNQUV2QyxNQUFNUyxZQUFZLEdBQUdGLFFBQVEsQ0FBQ0MsYUFBYSxDQUFDLElBQUksQ0FBQztNQUVqRCxNQUFNRSxZQUFZLEdBQUdILFFBQVEsQ0FBQ0MsYUFBYSxDQUFDLE1BQU0sQ0FBQztNQUNuREUsWUFBWSxDQUFDbEIsU0FBUyxDQUFDM0IsR0FBRyxDQUFDLE1BQU0sRUFBRSxhQUFhLEVBQUUsV0FBVyxDQUFDO01BQzlENEMsWUFBWSxDQUFDRSxXQUFXLENBQUNELFlBQVksQ0FBQztNQUV0QyxNQUFNRSxjQUFjLEdBQUdMLFFBQVEsQ0FBQ0MsYUFBYSxDQUFDLE1BQU0sQ0FBQztNQUNyREksY0FBYyxDQUFDQyxXQUFXLEdBQUdYLFVBQVU7TUFDdkNPLFlBQVksQ0FBQ0UsV0FBVyxDQUFDQyxjQUFjLENBQUM7TUFFeENOLGFBQWEsQ0FBQ0ssV0FBVyxDQUFDRixZQUFZLENBQUM7TUFFdkMsTUFBTUssU0FBUyxHQUFHUCxRQUFRLENBQUNDLGFBQWEsQ0FBQyxJQUFJLENBQUM7TUFDOUNNLFNBQVMsQ0FBQ0QsV0FBVyxHQUFHYixPQUFPO01BQy9CTSxhQUFhLENBQUNLLFdBQVcsQ0FBQ0csU0FBUyxDQUFDO01BRXBDLE1BQU1DLFVBQVUsR0FBR1IsUUFBUSxDQUFDQyxhQUFhLENBQUMsSUFBSSxDQUFDO01BQy9DTyxVQUFVLENBQUNGLFdBQVcsR0FBR1YsUUFBUTtNQUNqQ0csYUFBYSxDQUFDSyxXQUFXLENBQUNJLFVBQVUsQ0FBQztNQUVyQyxNQUFNQyxRQUFRLEdBQUdULFFBQVEsQ0FBQ0MsYUFBYSxDQUFDLElBQUksQ0FBQztNQUM3Q1EsUUFBUSxDQUFDSCxXQUFXLEdBQUdJLHlCQUFnQixDQUFDQyxlQUFlLENBQUNkLE1BQU0sQ0FBQztNQUMvREUsYUFBYSxDQUFDSyxXQUFXLENBQUNLLFFBQVEsQ0FBQztNQUVuQyxJQUFJLENBQUMvRCxJQUFJLENBQUM2QixlQUFlLENBQUM2QixXQUFXLENBQUNMLGFBQWEsQ0FBQztJQUN0RDtFQUNGO0VBRUFsQywwQkFBMEIsQ0FBRTtJQUFDK0IsUUFBUTtJQUFFRCxVQUFVO0lBQUVGO0VBQU8sQ0FBQyxFQUFFO0lBQzNELElBQUltQixPQUFPO0lBQ1gsTUFBTUMsZUFBZSxHQUFHQyxhQUFJLENBQUNDLE9BQU8sQ0FBQ3hFLElBQUksQ0FBQzhCLE9BQU8sQ0FBQzJDLGlCQUFpQixFQUFFLENBQUM7SUFDdEUsSUFBSUgsZUFBZSxLQUFLLE9BQU8sRUFBRTtNQUMvQkQsT0FBTyxHQUFJO0FBQ2pCLEdBQUdoQixRQUFTO0FBQ1osS0FBS0QsVUFBVyxPQUFNRixPQUFRO0FBQzlCLENBQUM7SUFDRyxDQUFDLE1BQU07TUFDTG1CLE9BQU8sR0FBSTtBQUNqQixHQUFHaEIsUUFBUztBQUNaLEtBQUtELFVBQVcsT0FBTUYsT0FBUTtBQUM5QjtBQUNBLENBQUM7SUFDRztJQUVBbEQsSUFBSSxDQUFDMEUsU0FBUyxDQUFDQyxLQUFLLENBQUNOLE9BQU8sQ0FBQztFQUMvQjtBQUNGO0FBQUM7QUFBQSJ9